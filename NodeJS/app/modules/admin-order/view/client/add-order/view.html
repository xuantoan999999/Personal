<div id="mod-order-add" class="content-wrapper">
    <!-- Content Header (Page header) -->
    <section class="content-header">
        <h1>
            Thêm đơn hàng
            <small>Thêm đơn hàng</small>
        </h1>
        <ol class="breadcrumb">
            <li><a ui-sref="dashboard"><i class="fa fa-dashboard"></i> Home</a></li>
            <li><a class="active" ui-sref="order-list()">Đơn hàng</a></li>
        </ol>
    </section>
    <!-- Main content -->
    <section class="content">
        <div class="row">
            <div class="col-xs-12">
                <div class="box">
                    <div class="box-header">
                        <h3 class="box-title">Thêm đơn hàng</h3>
                        <div class="clearfix"></div>
                    </div>
                    <!-- /.box-header -->
                    <div class="box-body">
                        <div ng-show="vmOrA.loading" style="text-align: center;"><img src="/assets/loading.svg" alt=""></div>
                        <form novalidate name="addOrderForm" id="addOrderForm" ng-submit="vmOrA.addOrder(addOrderForm)" ng-if="!vmOrA.loading">

                            <!--Start: Delivery type-->
                            <div class="show-grid">
                                <div class="form-group">
                                    <label>Hình thức nhận hàng</label>
                                    <div class="form-inline">
                                        <label role="switcher">
                                            <input i-check type="radio" ng-model="vmOrA.orderAdd.delivery_type" value="CN">
                                            <span>Địa chỉ cá nhân</span>
                                        </label>
                                        <label role="switcher">
                                            <input i-check type="radio" ng-model="vmOrA.orderAdd.delivery_type" value="CT">
                                            <span>Nhận tại công ty Mua Hàng Việt</span>
                                        </label>
                                    </div>
                                </div>
                            </div>
                            <!--End: Delivery type-->

                            <!--Start: User-->
                            <div class="form-group">
                                <div class="show-grid">
                                    <div class="form-group">
                                        <label>Khách hàng</label>

                                        <div class="form-inline">
                                            <span role="switcher">
                                            <input i-check type="radio" ng-model="vmOrA.customerSignIn" value="true">
                                            <span>Thành viên</span>
                                            </span>

                                            <span role="switcher">
                                            <input i-check type="radio"  ng-model="vmOrA.customerSignIn" value="false">
                                            <span>Khách chưa đăng ký</span>
                                            </span>
                                        </div>
                                    </div>
                                </div>

                                <select ng-if="vmOrA.customerSignIn == 'true'" name="user" ng-model="vmOrA.orderAddTmp.user" ui-select2 class="form-control"
                                    ng-options="user as user.name for user in vmOrA.listUser track by user._id" ng-change="vmOrA.enableForm(addOrderForm); vmOrA.setDataUser(true);"></select>
                                <!--<div class="messages-error" ng-messages="addOrderForm.user.$error" ng-if="addOrderForm.$submitted">
                                    <div ng-message="required">Bạn chưa chọn thành viên.</div>
                                </div>-->
                            </div>
                            <!--End: User-->

                            <!--Start: Order detail-->
                            <div class="list-shipping-add" ng-if="vmOrA.customerSignIn == 'true' && vmOrA.orderAddTmp.user">
                                <table class="table table-bordered table-list-product">
                                    <tr>
                                        <th>Chọn thông tin giao hàng</th>
                                        <th>Họ tên</th>
                                        <th>Địa chỉ giao</th>
                                        <th>Số điện thoại</th>
                                    </tr>
                                    <tr ng-repeat="item in vmOrA.orderAddTmp.user.customer.shipping_address" ng-if="item.id_shipping_fee">
                                        <td>
                                            <label role="switcher">
                                                <input i-check type="radio" ng-disabled="vmOrA.orderAddTmp.user.deletedAt" ng-model="vmOrA.orderAddTmp.shippingAddress" name="shipping_address" value="[[item._id]]" ng-change="vmOrA.setPaymentInfo(); vmOrA.enableForm(addOrderForm); vmOrA.setTotalProduct();" required>
                                                <span>Chọn</span>
                                            </label>
                                        </td>
                                        <td>
                                            <span ng-bind="item.name"></span>
                                        </td>
                                        <td>
                                            <span ng-bind="item.address_detail +  ' - '+item.id_shipping_fee.district"></span>
                                        </td>
                                        <td>
                                            <span ng-bind="item.phone"></span>
                                        </td>
                                    </tr>
                                </table>

                                <div class="messages-error" ng-messages="addOrderForm.shipping_address.$error" ng-if="addOrderForm.$submitted">
                                    <div ng-message="required">Bạn chưa chọn thông tin giao hàng.</div>
                                </div>
                                <div class="text-red" ng-if="!vmOrA.orderAddTmp.shippingAddress && addOrderForm.$submitted">
                                    <p>Bạn chưa chọn thông tin giao hàng.</p>
                                </div>
                            </div>
                            <!--End: Order detail-->

                            <!--Start Payment info-->
                            <div class="row">
                                <div class="col-sm-2">
                                    <!--Start: Vocative-->
                                    <div class="form-group">
                                        <label>Danh xưng:</label>
                                        <select class="form-control" id="vocative" name="vocative" ng-model="vmOrA.orderAdd.payment_info.info.vocative" ng-options="vocative.name as vocative.value for vocative in vmOrA.listVocative" ui-select2></select>
                                    </div>
                                    <!--End: Vocative-->
                                </div>

                                <div class="col-sm-4">
                                    <div class="form-group">
                                        <!--Start: Vocative-->
                                        <label>Tên khách hàng:</label>
                                        <input type="text" class="form-control" name="vocative" id="vocative" ng-model="vmOrA.orderAdd.payment_info.info.full_name">
                                    </div>
                                    <!--End: address-->
                                </div>
                                <div class="col-sm-3">
                                    <!--Start: Email-->
                                    <div class="form-group">
                                        <label>Email:</label>
                                        <input type="text" class="form-control" name="email" id="email" ng-model="vmOrA.orderAdd.payment_info.info.email" ng-change="vmOrA.enableForm(addOrderForm)"
                                            ng-pattern="/^([a-zA-Z0-9_\.\-])+\@(([a-zA-Z0-9\-])+\.)+([a-zA-Z0-9]{2,4})+$/">
                                        <div class="messages-error" ng-messages="addOrderForm.email.$error" ng-if="addOrderForm.$submitted">
                                            <div ng-message="pattern">Email không hợp lệ.</div>
                                        </div>
                                    </div>
                                    <!--End: Email-->
                                </div>
                                <div class="col-sm-3">
                                    <!--Start: Phone-->
                                    <div class="form-group">
                                        <label>Điện thoại:</label>
                                        <input type="text" class="form-control" name="info_phone" id="info_phone" ng-model="vmOrA.orderAdd.payment_info.info.phone"
                                            ng-change="vmOrA.enableForm(addOrderForm)" ng-pattern="/^0[\d]{9,10}/" bz-input-only-digits
                                            ng-minlength="10" ng-maxlength="11">
                                        <div class="messages-error" ng-messages="addOrderForm.info_phone.$error" ng-if="addOrderForm.$submitted">
                                            <div ng-message="minlength">Bạn cần nhập ít nhất 10 số</div>
                                            <div ng-message="maxlength">Số điện thoại quá dài</div>
                                            <div ng-message="pattern">Điện thoại không hợp lệ, phải có số 0 đầu</div>
                                        </div>
                                    </div>
                                    <!--End: Phone-->
                                </div>
                            </div>
                            <!--END Payment info-->


                            <!--Start: address-->
                            <div class="row">
                                <div class="col-sm-6">
                                    <div class="form-group">
                                        <label>Địa chỉ giao hàng</label>
                                        <input type="text" class="form-control" name="vocative" id="vocative" ng-model="vmOrA.orderAdd.payment_info.info.address">
                                    </div>
                                </div>
                                <div class="col-sm-6">
                                    <div class="form-group">
                                        <label>Quận huyện:</label>
                                        <input type="text" class="form-control" name="info_district" id="info_district" ng-disabled="true" ng-model="vmOrA.orderAdd.payment_info.info.district">
                                    </div>
                                </div>
                            </div>
                            <!--End: address-->


                            <!--Start: Coupon-->
                            <div class="form-group">
                                <label>Phiếu giảm giá</label>
                                <select name="coupon" ng-model="vmOrA.orderAdd.id_coupon" class="form-control" ui-select2 ng-change="vmOrA.getCoupon(true); vmOrA.setTotalProduct()">
                                    <option value="">Chọn phiếu giảm giá</option>
                                    <option value="[[coupon._id]]" ng-repeat="coupon in vmOrA.listCoupon">[[coupon.code]]</option>
                                </select>
                            </div>
                            <!--End: Coupon-->

                            <!--Start: Payment method-->
                            <div class="form-group">
                                <label>Hình thức thanh toán</label>
                                <div class="form-inline">
                                    <div>
                                        <label role="switcher">
                                            <input i-check type="radio" ng-model="vmOrA.orderAdd.payment_method" value="COD">
                                            <span>COD</span>
                                        </label>
                                    </div>
                                    <div>
                                        <label role="switcher">
                                            <input i-check type="radio" ng-model="vmOrA.orderAdd.payment_method" value="CK">
                                            <span>Chuyển khoản</span>
                                        </label>
                                    </div>
                                </div>
                            </div>
                            <!--End: Payment method-->

                            <!--Start: Time-->
                            <div class="form-group">
                                <div class="form-group">
                                    <label>Thời gian giao hàng</label>
                                    <div class="form-inline">
                                        <label role="switcher">
                                            <input i-check type="radio" ng-model="vmOrA.orderAdd.delivery_time" value="SANG" ng-change="vmOrA.setTotalProduct()">
                                            <span>Sáng 10:30 - 12:00</span>
                                        </label>
                                        <label role="switcher">
                                            <input i-check type="radio" ng-model="vmOrA.orderAdd.delivery_time" value="CHIEU" ng-change="vmOrA.setTotalProduct()">
                                            <span>Chiều 14:00 - 17:00</span>
                                        </label>
                                    </div>
                                </div>
                            </div>
                            <!--End: Time-->

                            <!--Start: Type-->
                            <div class="form-group">
                                <div class="form-group">
                                    <label>Loại</label>
                                    <div class="form-inline">
                                        <label role="switcher">
                                            <input i-check type="radio" ng-model="vmOrA.orderAdd.type" value="BT">
                                            <span>Bình thường</span>
                                        </label>
                                        <label role="switcher">
                                            <input i-check type="radio" ng-model="vmOrA.orderAdd.type" value="TL">
                                            <span>Thanh lý</span>
                                        </label>
                                    </div>
                                </div>
                            </div>
                            <!--End: Type-->

                            <!--Start: Status-->
                            <div class="form-group">
                                <label>Trạng thái <span class="text-red">(*)</span></label>
                                <select name="status" class="form-control" ng-model="vmOrA.orderAdd.status" class="form-control" ng-options="option.value as option.name group by option.group for option in vmOrA.statusOrderList"
                                    ng-change="vmOrA.enableForm(addOrderForm)" required></select>
                                <div class="messages-error" ng-messages="addOrderForm.status.$error" ng-if="addOrderForm.$submitted">
                                    <div ng-message="required">Bạn chưa chọn trạng thái.</div>
                                </div>
                            </div>
                            <!--End: Status-->

                            <!--Start: Shipping date-->
                            <div class="form-group">
                                <label>Ngày giao hàng</label>
                                <input type="text" class="form-control" placeholder="Ngày giao hàng" ng-model="vmOrA.orderAdd.ship_date" id="datetime-picker"
                                    atr-date-time-picker atr-options="vmOrA.dateTimePickerOpt">
                            </div>
                            <!--End: Shipping date-->

                            <!--Start: Shipper-->
                            <div class="form-group">
                                <label>Đơn vị giao đơn hàng <span class="text-red">(*)</span></label>
                                <select name="shiper" class="form-control" ng-model="vmOrA.orderAdd.shiper" class="form-control" ng-options="option.value as option.name group by option.group for option in vmOrA.shipperList"
                                    ng-change="vmOrA.enableForm(addOrderForm)" required></select>
                                <div class="messages-error" ng-messages="addOrderForm.shiper.$error" ng-if="addOrderForm.$submitted">
                                    <div ng-message="required">Bạn chưa chọn đơn vị giao đơn hàng.</div>
                                </div>
                            </div>
                            <!--End: Shipper-->

                            <!--Start: Note-->
                            <div class="form-group">
                                <label>Ghi chú giao hàng</label>
                                <textarea rows="5" class="form-control" ng-model="vmOrA.orderAdd.note"></textarea>
                            </div>
                            <!--End: Note-->

                            <!--Start: List Product-->
                            <div class="form-group product-select">
                                <label>Sản phẩm <span class="text-red">(*)</span></label>
                                <select name="product_list" ng-model="vmOrA.orderAddTmp.orderDetailProduct" class="form-control" ui-select2 multiple ng-change="vmOrA.getOrderDetail(); vmOrA.enableForm(addOrderForm); vmOrA.setTotalProduct();"
                                    required>
                                    <option value="[[item._id]]" ng-repeat="item in vmOrA.listProduct" ng-bind="item.name"></option>
                                </select>
                                <div class="messages-error" ng-messages="addOrderForm.product_list.$error" ng-if="addOrderForm.$submitted">
                                    <div ng-message="required">Bạn chưa chọn sản phẩm.</div>
                                </div>
                            </div>
                            <!--End: List Product-->

                            <!--Start: Order Detail-->
                            <div class="order-detail" ng-show="vmOrA.orderAdd.order_detail && vmOrA.orderAdd.order_detail.length > 0">
                                <table class="table table-bordered table-list-product">
                                    <tr>
                                        <th>Sản phẩm</th>
                                        <th>Đơn giá</th>
                                        <th>Số lượng</th>
                                        <th>Giảm giá</th>
                                        <th>Tổng cộng</th>
                                    </tr>
                                    <tr ng-repeat="item in vmOrA.orderAdd.order_detail">
                                        <td>
                                            <img class="img-product" ng-src="[[vmOrA.checkImgOld(vmOrA.urlImg,item.product_obj.thumb)]]" alt="Product image">
                                            <span ng-bind="item.product_obj.name"></span>
                                        </td>
                                        <td>
                                            <span ng-bind="item.price | currency : '':0"></span> đ
                                        </td>
                                        <td>
                                            <input type="number" name="order_quantity_[[item.product]]" ng-model="item.order_quantity" min="1" max="[[item.product_obj.qty_in_stock]]"
                                                class="form-control input-number" ng-change="vmOrA.setTotalProduct(); vmOrA.enableForm(addOrderForm);"
                                                required>
                                            <span class="text-red">(*)</span>
                                            <div class="messages-error" ng-messages="addOrderForm['order_quantity_' + item.product].$error">
                                                <div ng-message="max">Số lượng đặt vượt quá số lượng tồn kho.</div>
                                            </div>
                                            <div class="messages-error" ng-messages="addOrderForm['order_quantity_' + item.product].$error" ng-if="addOrderForm.$submitted">
                                                <div ng-message="required">Vui lòng nhập số lượng đặt.</div>
                                                <div ng-message="min">Số lượng đặt tối thiểu là 1.</div>
                                            </div>
                                        </td>
                                        <td>
                                            <p ng-if="item.id_promote.id">
                                                <span ng-bind="item.id_promote.name"></span> - Giảm [[item.id_promote.value]]
                                                <span ng-switch="item.id_promote.type">
                                                    <span ng-switch-when="PC">%</span>
                                                <span ng-switch-when="MN">đ</span>
                                                </span>
                                            </p>
                                        </td>
                                        <td>
                                            <p ng-show="item.order_quantity">
                                                <span ng-bind="item.total | currency : '':0"></span> đ
                                            </p>
                                        </td>
                                    </tr>
                                </table>
                                <div class="info-order text-right">
                                    <p>
                                        <label>Tổng cộng: </label>
                                        <span class="value-order-info" ng-bind="vmOrA.orderAdd.total | currency : '':0"></span>                                        đ
                                    </p>
                                    <p ng-show="vmOrA.shippingTmp.fee">
                                        <label>Phí vận chuyển: </label>
                                        <span class="value-order-info" ng-bind="vmOrA.shippingTmp.fee | currency : '':0"></span>                                        đ
                                    </p>
                                    <p>
                                        <label>Tiền khuyến mãi: </label>
                                        <span>
                                            [[ vmOrA.orderAdd.coupon.value + ((vmOrA.orderAdd.delivery_time == 'CHIEU')? (vmOrA.configBC.type
                                            == "PC" ? ((vmOrA.configBC.value/100) * vmOrA.orderAdd.total) : vmOrA.configBC.value
                                            ) : 0 ) + (vmOrA.isFirstOder? ( vmOrA.configDT.type == "MN"? vmOrA.configDT.value
                                            :( (vmOrA.configDT.value/100) * vmOrA.orderAdd.total) ): 0) | currency:"":0]]  ₫
                                        </span>
                                    </p>

                                    <p class="text-green" ng-if="vmOrA.orderAdd.delivery_time =='CHIEU'">
                                        <strong ng-bind="vmOrA.configBC.description"></strong>
                                    </p>
                                    <p class="text-green" ng-if="vmOrA.isFirstOder">
                                        <strong ng-bind="vmOrA.configDT.description"></strong>
                                    </p>
                                    <p class="text-green" ng-if="vmOrA.shippingTmp.type == '1' && vmOrA.orderAdd.total > vmOrA.configNT.value">
                                        <strong ng-bind="vmOrA.configNT.description"></strong>
                                    </p>
                                    <p class="text-green" ng-if="vmOrA.shippingTmp.type == '2' && vmOrA.orderAdd.total > vmOrA.configNGT.value">
                                        <strong ng-bind="vmOrA.configNGT.description"></strong>
                                    </p>
                                    <p class="text-green" ng-if="vmOrA.orderAdd.id_coupon">
                                        <strong ng-bind="'Coupon: ' + vmOrA.orderAdd.coupon.name"></strong>
                                    </p>

                                    <p class="text-red" ng-if="!isNaN(vmOrA.orderAdd.total)">
                                        <strong ng-bind="vmOrA.orderAdd.total_pay | currency : '':0"></strong> đ
                                    </p>
                                </div>
                            </div>
                            <!--End: Order Detail-->

                            <!--Start: Submit button-->
                            <div class="form-group text-right">
                                <a class="btn btn-primary btn-flat" ui-sref="order-list()">
                                    <i class="glyphicon glyphicon-remove"></i> Hủy bỏ
                                </a>
                                <button type="submit" ng-disabled="addOrderForm.$submitted" class="btn btn-success btn-flat">
                                    <i class="glyphicon glyphicon-floppy-disk"></i>
                                    Thêm
                                </button>
                                <div class="clearfix"></div>
                            </div>
                            <!--End: Submit button-->
                        </form>
                    </div>
                    <!-- /.box-body -->
                </div>
                <!-- /.box -->
            </div>
            <!-- /.col -->
        </div>
        <!-- /.row -->
    </section>
    <!-- /.content -->
</div>